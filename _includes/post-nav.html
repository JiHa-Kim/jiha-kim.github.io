{% assign previous = site.data.locales[include.lang].post.button.previous %}
{% assign next = site.data.locales[include.lang].post.button.next %}

{%- comment -%}
  1. Determine the set of pages to navigate through.
     - If the page is in a collection (and not 'posts'), we navigate within that specific series/course.
     - Otherwise, we navigate through the regular blog posts.
{%- endcomment -%}
{% if page.collection and page.collection != 'posts' %}
  {%- comment -%}
    This is a page within a custom collection (like 'series' or 'crash-courses').
    We need to filter to only items in the same subfolder.
  {%- endcomment -%}

  {%- comment -%}
    Extract the subfolder from the page path.
    e.g., "_crash-courses/functional-analysis/5-matrix-norms.md" -> "functional-analysis"
  {%- endcomment -%}
  {% assign path_parts = page.path | split: '/' %}
  {% assign collection_folder = path_parts | first %}
  {% assign subfolder = path_parts | slice: 1, 1 | first %}

  {%- comment -%}
    Build the path prefix to match only files in the same subfolder.
    e.g., "_crash-courses/functional-analysis/"
  {%- endcomment -%}
  {% capture source_prefix %}{{ collection_folder }}/{{ subfolder }}/{% endcapture %}

  {%- comment -%}
    Get the collection items and filter by subfolder, then sort by sort_index.
  {%- endcomment -%}
  {%- assign collection_items = site[page.collection] -%}
  {%- assign sorted = collection_items | where_exp: 'item', 'item.path contains source_prefix' | sort: 'sort_index' -%}

{% else %}
  {%- comment -%}
    This is a regular blog post. Navigation will be through all posts by date.
  {%- endcomment -%}
  {%- assign sorted = site.posts -%}
{% endif %}

{%- comment -%}
  2. Find the current page's index within the sorted list.
{%- endcomment -%}
{% assign current_index = -1 %}
{% for item in sorted %}
  {% if item.url == page.url %}
    {% assign current_index = forloop.index0 %}
    {% break %}
  {% endif %}
{% endfor %}

{%- comment -%}
  3. Determine the previous and next items.
{%- endcomment -%}
{% assign prev_item = null %}
{% assign next_item = null %}
{% if current_index >= 0 %}
  {% assign prev_index = current_index | minus: 1 %}
  {% assign next_index = current_index | plus: 1 %}

  {% if prev_index >= 0 %}
    {% assign prev_item = sorted[prev_index] %}
  {% endif %}

  {% if next_index < sorted.size %}
    {% assign next_item = sorted[next_index] %}
  {% endif %}
{% endif %}

{%- comment -%}
  4. Render the navigation buttons.
{%- endcomment -%}
<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  {% if prev_item %}
    <a
      href="{{ site.baseurl }}{{ prev_item.url }}"
      class="btn btn-outline-primary"
      aria-label="{{ previous }}"
    >
      <p>{{ prev_item.title }}</p>
    </a>
  {% else %}
    <div class="btn btn-outline-primary disabled" aria-label="{{ previous }}">
      <p>-</p>
    </div>
  {% endif %}

  {% if next_item %}
    <a
      href="{{ site.baseurl }}{{ next_item.url }}"
      class="btn btn-outline-primary"
      aria-label="{{ next }}"
    >
      <p>{{ next_item.title }}</p>
    </a>
  {% else %}
    <div class="btn btn-outline-primary disabled" aria-label="{{ next }}">
      <p>-</p>
    </div>
  {% endif %}
</nav>
